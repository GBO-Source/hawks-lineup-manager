<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hawks 503 Lineup Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        /* Custom styles for drag-and-drop */
        .player-card {
            cursor: grab;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .player-card:active {
            cursor: grabbing;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 4, 18, 0.05);
            transform: scale(1.02);
        }
        .lineup-slot {
            min-height: 4rem;
            transition: background-color 0.15s, border-color 0.15s;
        }
        .drag-over {
            background-color: #e0f2fe !important;
            border-color: #3b82f6 !important;
        }
        
        /* Color Coding based on Shot */
        .is-lh {
            background-color: #fff7ed;
            color: #c2410c;
            border-color: #fb923c;
        }
        .is-rh {
            background-color: #fefce8;
            color: #a16207;
            border-color: #facc15;
        }
        .is-goalie-type {
            background-color: #fef2f2;
            color: #b91c1c;
            border-color: #f87171;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="mb-8">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Hawks 503 Lineup Manager üèí</h1>
        <p class="text-lg text-gray-600">Build your lines using Name, Number, and Shot (LH/RH).</p>
    </header>

    <section class="bg-white p-6 rounded-xl shadow-lg mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Game & Roster Setup</h2>

        <div id="auth-info" class="text-sm text-gray-500 mb-4 flex justify-between items-center">
            <span id="user-id-display" class="font-medium text-red-500">Initializing...</span>
            <span id="app-id-display"></span>
        </div>

        <div class="mb-4 flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-4">
            <label for="game-selector" class="font-medium text-gray-700">Load/New Game:</label>
            <select id="game-selector" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></select>
            <button onclick="createNewGame()" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition duration-150 shadow-md whitespace-nowrap">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                New Game
            </button>
            <button onclick="saveGame()" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7z" />
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                Save Lineup
            </button>
        </div>

        <div class="mt-6">
            <label for="csv-input" class="block font-medium text-gray-700 mb-1">Roster Data (Edit and click "Load Roster" to update):</label>
            <textarea id="csv-input" rows="8" placeholder="Example:&#10;Name,Number,Shot&#10;Connor McDavid,97,RH&#10;Leon Draisaitl,29,LH&#10;..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm"></textarea>
            <button onclick="loadRosterData()" class="mt-2 bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md w-full">Load Roster</button>
        </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

        <section class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Available Roster (<span id="roster-count">0</span>)</h2>
            <div id="roster-list" class="space-y-2 max-h-[60vh] overflow-y-auto">
            </div>
        </section>

        <section class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Current Lineup</h2>

            <h3 class="text-xl font-medium text-blue-800 mb-2 mt-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                </svg>
                Forward Lines (4)
            </h3>
            <div id="forward-lines" class="space-y-4">
            </div>

            <h3 class="text-xl font-medium text-green-800 mb-2 mt-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                Defense Pairings (3)
            </h3>
            <div id="defense-lines" class="space-y-4">
            </div>

            <h3 class="text-xl font-medium text-red-800 mb-2 mt-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                </svg>
                Goalie (1)
            </h3>
            <div id="goalie-line" class="grid grid-cols-1 gap-4">
            </div>

        </section>
    </div>

    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
            <p id="modal-message" class="mb-4 text-gray-600"></p>
            <button onclick="closeModal()" class="w-full bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition duration-150">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');
        
        // FIREBASE CONFIGURATION
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCDA5e0ukol0Smd6lKfk8heB_nFLOajPCM",
            authDomain: "hawks-lineup-manager.firebaseapp.com",
            databaseURL: "https://hawks-lineup-manager-default-rtdb.firebaseio.com",
            projectId: "hawks-lineup-manager",
            storageBucket: "hawks-lineup-manager.firebasestorage.app",
            messagingSenderId: "96161354471",
            appId: "1:96161354471:web:5524590c7d657a36a54842"
        };

        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS4nukvK7D-Q__ZKwqPbzflUAl0NOPjvad3PN-FAU_P79fnscTZmfaYhwgoIqf8AWCPTl6tVN6UYx2J/pub?gid=1943714911&single=true&output=csv';

        const DEFAULT_ROSTER_CSV = `Name,Number,Shot
Ajay,	19,	RH
Ben,	14,	RH
Colson,	9,	RH
Fergus,	8,	LH
Frankie,	7,	RH
Griffin,	15,	RH
Halen,	12,	LH
Jack,	11,	RH
Jackson,	17	LH
Jameson,	5	RH
Jayden,	18,	LH
Jordon,	6,	RH
Keenan,	13,	LH
Lieven,	1,	LH
Oliver,	4,	RH
Rowan,	2,	RH
Sam,	16,	LH
`;
        
        let app;
        let db;
        let auth;
        let userId = 'anon';
        let isAuthReady = false;

        let currentGameId = null;
        let allGames = [];
        let masterRoster = [];
        let availableRoster = [];
        
        // UPDATED LINEUP STRUCTURE TO AVOID NESTED ARRAYS FOR FIREBASE COMPATIBILITY
        let currentLineup = {
            // Forwards: Keyed by line number (1-4)
            forwards: {
                'Line1': {
                    LF: {role: 'Left Forward', roleId: 'LF', player: null},
                    CF: {role: 'Center Forward', roleId: 'CF', player: null},
                    RF: {role: 'Right Forward', roleId: 'RF', player: null}
                },
                'Line2': {
                    LF: {role: 'Left Forward', roleId: 'LF', player: null},
                    CF: {role: 'Center Forward', roleId: 'CF', player: null},
                    RF: {role: 'Right Forward', roleId: 'RF', player: null}
                },
                'Line3': {
                    LF: {role: 'Left Forward', roleId: 'LF', player: null},
                    CF: {role: 'Center Forward', roleId: 'CF', player: null},
                    RF: {role: 'Right Forward', roleId: 'RF', player: null}
                },
                'Line4': {
                    LF: {role: 'Left Forward', roleId: 'LF', player: null},
                    CF: {role: 'Center Forward', roleId: 'CF', player: null},
                    RF: {role: 'Right Forward', roleId: 'RF', player: null}
                }
            },
            // Defense: Keyed by pair number (1-3)
            defense: {
                'Pair1': {
                    LD: {role: 'Left Defense', roleId: 'LD', player: null},
                    RD: {role: 'Right Defense', roleId: 'RD', player: null}
                },
                'Pair2': {
                    LD: {role: 'Left Defense', roleId: 'LD', player: null},
                    RD: {role: 'Right Defense', roleId: 'RD', player: null}
                },
                'Pair3': {
                    LD: {role: 'Left Defense', roleId: 'LD', player: null},
                    RD: {role: 'Right Defense', roleId: 'RD', player: null}
                }
            },
            goalie: {role: 'Goalie', roleId: 'G', player: null}
        };

        const rosterListEl = document.getElementById('roster-list');
        const rosterCountEl = document.getElementById('roster-count');
        const forwardLinesEl = document.getElementById('forward-lines');
        const defenseLinesEl = document.getElementById('defense-lines');
        const goalieLineEl = document.getElementById('goalie-line');
        const gameSelectorEl = document.getElementById('game-selector');
        const csvInputEl = document.getElementById('csv-input');

        const generateUUID = () => crypto.randomUUID();

        window.showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('message-modal').classList.add('flex');
        };

        window.closeModal = () => {
            document.getElementById('message-modal').classList.add('hidden');
            document.getElementById('message-modal').classList.remove('flex');
        };

        const initializeFirebase = async () => {
            let firebaseConfig = FIREBASE_CONFIG;
            let appId = 'hawks-503-lineup'; 
            let failureReason = "Unknown initialization failure.";

            try {
                if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.projectId) {
                    failureReason = "Firebase configuration is invalid or incomplete.";
                    console.error("FIREBASE ERROR:", failureReason);
                    throw new Error("Invalid Firebase configuration.");
                }

                console.log("DEBUG INFO: Initializing Firebase with project:", firebaseConfig.projectId);

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                document.getElementById('app-id-display').textContent = `App ID: ${appId}`;

                console.log("DEBUG INFO: Attempting anonymous sign-in...");
                await signInAnonymously(auth);
                console.log("DEBUG INFO: Anonymous sign-in successful.");
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `User ID: ${userId.substring(0, 8)}...`;
                    } else {
                        userId = crypto.randomUUID();
                        document.getElementById('user-id-display').textContent = `User ID: anon (${userId.substring(0, 4)}...)`;
                    }
                    isAuthReady = true;
                    document.getElementById('user-id-display').classList.remove('text-red-500');
                    document.getElementById('user-id-display').classList.add('text-gray-500');
                    console.log("DEBUG INFO: Auth state ready. User ID:", userId);
                    setupGameListener(appId);
                });

            } catch (error) {
                console.error("FATAL FIREBASE SETUP ERROR:", error.message, error);
                document.getElementById('user-id-display').textContent = `ERROR: ${failureReason}`;
                showModal("Firebase Error", `Failed to initialize Firebase. Reason: ${failureReason}. Loading default roster.`);
                loadRosterData(true);
            }
        };

        const getGamesCollectionRef = (appId) => {
            return collection(db, `hockey_lineups/${appId}/games`);
        };

        const setupGameListener = (appId) => {
            if (!isAuthReady || !db) {
                if (masterRoster.length === 0) {
                    loadRosterData(true);
                }
                return;
            }

            const gamesQuery = query(getGamesCollectionRef(appId));

            onSnapshot(gamesQuery, (snapshot) => {
                allGames = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGameSelector();
                console.log("Loaded all game templates:", allGames.length);
                if (allGames.length > 0) {
                    if (!currentGameId || !allGames.some(g => g.id === currentGameId)) {
                        selectGame(allGames[0].id);
                    } else {
                        selectGame(currentGameId);
                    }
                } else {
                    if (masterRoster.length === 0) {
                        loadRosterData(true);
                    }
                    if (!currentGameId) {
                        createNewGame();
                    } else {
                        renderAll();
                    }
                }
            }, (error) => {
                console.error("Error fetching games:", error);
                showModal("Data Fetch Error", "Failed to fetch saved games. Check Firebase security rules.");
                loadRosterData(true);
            });
        };

        window.saveGame = async () => {
            const appId = 'hawks-503-lineup';
            if (!currentGameId || !isAuthReady || !db) {
                showModal("Save Error", "The app is not fully initialized. Please wait and try again.");
                return;
            }

            const gameSelector = document.getElementById('game-selector');
            const selectedOption = gameSelector.querySelector(`option[value="${currentGameId}"]`);
            const gameName = selectedOption ? selectedOption.textContent : `Game ${currentGameId.substring(0, 8)}`;

            const gameData = {
                id: currentGameId,
                name: gameName,
                masterRoster: masterRoster,
                lineup: currentLineup,
                availableRoster: availableRoster,
                updatedBy: userId,
                updatedAt: new Date().toISOString()
            };

            try {
                const gameDocRef = doc(db, `hockey_lineups/${appId}/games`, currentGameId);
                await setDoc(gameDocRef, gameData);
                showModal("Success!", `Lineup "${gameData.name}" saved successfully.`);
            } catch (error) {
                console.error("Error saving game:", error);
                showModal("Save Error", `Failed to save the lineup. Error: ${error.message}`);
            }
        };

        window.createNewGame = () => {
            const newGameId = generateUUID();
            const timestamp = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            const newGameName = `New Game - ${timestamp}`;

            currentGameId = newGameId;
            
            // Use the object structure for a new game
            currentLineup = {
                forwards: {
                    'Line1': { LF: { role: 'Left Forward', roleId: 'LF', player: null }, CF: { role: 'Center Forward', roleId: 'CF', player: null }, RF: { role: 'Right Forward', roleId: 'RF', player: null } },
                    'Line2': { LF: { role: 'Left Forward', roleId: 'LF', player: null }, CF: { role: 'Center Forward', roleId: 'CF', player: null }, RF: { role: 'Right Forward', roleId: 'RF', player: null } },
                    'Line3': { LF: { role: 'Left Forward', roleId: 'LF', player: null }, CF: { role: 'Center Forward', roleId: 'CF', player: null }, RF: { role: 'Right Forward', roleId: 'RF', player: null } },
                    'Line4': { LF: { role: 'Left Forward', roleId: 'LF', player: null }, CF: { role: 'Center Forward', roleId: 'CF', player: null }, RF: { role: 'Right Forward', roleId: 'RF', player: null } }
                },
                defense: {
                    'Pair1': { LD: { role: 'Left Defense', roleId: 'LD', player: null }, RD: { role: 'Right Defense', roleId: 'RD', player: null } },
                    'Pair2': { LD: { role: 'Left Defense', roleId: 'LD', player: null }, RD: { role: 'Right Defense', roleId: 'RD', player: null } },
                    'Pair3': { LD: { role: 'Left Defense', roleId: 'LD', player: null }, RD: { role: 'Right Defense', roleId: 'RD', player: null } }
                },
                goalie: {role: 'Goalie', roleId: 'G', player: null}
            };
            availableRoster = [...masterRoster];

            const newGameData = { 
                id: newGameId, 
                name: newGameName, 
                masterRoster: masterRoster, 
                lineup: currentLineup, 
                availableRoster: availableRoster 
            };
            allGames.push(newGameData);
            renderGameSelector();
            gameSelectorEl.value = newGameId;
            selectGame(newGameId);

            if (masterRoster.length > 0) {
                showModal("Game Created", `A new game "${newGameName}" has been created. Remember to Save!`);
            }
        };

        const selectGame = (id) => {
            const selectedGame = allGames.find(g => g.id === id);
            if (!selectedGame) {
                console.error("Game ID not found:", id);
                return;
            }

            currentGameId = selectedGame.id;
            masterRoster = selectedGame.masterRoster || [];
            currentLineup = selectedGame.lineup || currentLineup;
            availableRoster = selectedGame.availableRoster || [...masterRoster];

            if (masterRoster.length > 0) {
                const rosterCSV = masterRoster.map(p => `${p.name},${p.number},${p.shot}`).join('\n');
                csvInputEl.value = "Name,Number,Shot\n" + rosterCSV;
            } else {
                csvInputEl.value = DEFAULT_ROSTER_CSV.trim();
            }

            renderAll();
            renderGameSelector();
        };

        const renderGameSelector = () => {
            gameSelectorEl.innerHTML = '';

            if (!allGames.some(g => g.id === currentGameId) && currentGameId) {
                const localGame = { id: currentGameId, name: `[Local] Game ${currentGameId.substring(0, 8)}...` };
                allGames.push(localGame);
            }

            allGames.forEach(game => {
                const option = document.createElement('option');
                option.value = game.id;
                option.textContent = game.name;
                gameSelectorEl.appendChild(option);
            });

            if (currentGameId) {
                gameSelectorEl.value = currentGameId;
            }
        };

        gameSelectorEl.addEventListener('change', (event) => {
            selectGame(event.target.value);
        });

        const parseRoster = (data) => {
            if (!data) {
                masterRoster = [];
                return false;
            }

            const lines = data.trim().split('\n').filter(line => line.trim() !== '');
            const playerLines = lines.slice(1);

            masterRoster = playerLines.map((line, index) => {
                const parts = line.split(',').map(p => p.trim());
                const [name, number, shot] = parts;
                
                return {
                    id: generateUUID(),
                    name: name || `Player ${index + 1}`,
                    number: number || '',
                    shot: shot ? shot.toUpperCase() : 'RH',
                    rosterKey: `${name}-${number}-${shot}` 
                };
            }).filter(p => p.name);

            if (masterRoster.length > 0) {
                availableRoster = [...masterRoster];

                if (currentGameId) {
                    // Reset lineup using object structure
                    currentLineup = {
                        forwards: {
                            'Line1': { LF: { role: 'Left Forward', roleId: 'LF', player: null }, CF: { role: 'Center Forward', roleId: 'CF', player: null }, RF: { role: 'Right Forward', roleId: 'RF', player: null } },
                            'Line2': { LF: { role: 'Left Forward', roleId: 'LF', player: null }, CF: { role: 'Center Forward', roleId: 'CF', player: null }, RF: { role: 'Right Forward', roleId: 'RF', player: null } },
                            'Line3': { LF: { role: 'Left Forward', roleId: 'LF', player: null }, CF: { role: 'Center Forward', roleId: 'CF', player: null }, RF: { role: 'Right Forward', roleId: 'RF', player: null } },
                            'Line4': { LF: { role: 'Left Forward', roleId: 'LF', player: null }, CF: { role: 'Center Forward', roleId: 'CF', player: null }, RF: { role: 'Right Forward', roleId: 'RF', player: null } }
                        },
                        defense: {
                            'Pair1': { LD: { role: 'Left Defense', roleId: 'LD', player: null }, RD: { role: 'Right Defense', roleId: 'RD', player: null } },
                            'Pair2': { LD: { role: 'Left Defense', roleId: 'LD', player: null }, RD: { role: 'Right Defense', roleId: 'RD', player: null } },
                            'Pair3': { LD: { role: 'Left Defense', roleId: 'LD', player: null }, RD: { role: 'Right Defense', roleId: 'RD', player: null } }
                        },
                        goalie: {role: 'Goalie', roleId: 'G', player: null}
                    };
                }

                renderAll();
                return true;
            }
            return false;
        };

        window.loadRosterData = async (isInitialLoad = false) => {
            let rosterData = csvInputEl.value.trim();
            let source = "text input";

            if (!rosterData) {
                if (GOOGLE_SHEET_URL.includes('PASTE_YOUR') || GOOGLE_SHEET_URL === '') {
                    rosterData = DEFAULT_ROSTER_CSV;
                    source = "default hardcoded list";
                    csvInputEl.value = rosterData.trim();
                } else {
                    source = "Google Sheet URL";
                    if (!isInitialLoad) {
                        showModal("Loading...", "Fetching roster data from Google Sheet...");
                    }

                    try {
                        const response = await fetch(GOOGLE_SHEET_URL);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        rosterData = await response.text();
                        csvInputEl.value = rosterData.trim(); 
                        closeModal();
                    } catch (error) {
                        console.error("Fetch Roster Error:", error);
                        showModal("Connection Error", "Failed to load from Google Sheet. Using default roster.");
                        rosterData = DEFAULT_ROSTER_CSV; 
                        source = "default hardcoded list (after fetch failure)";
                        csvInputEl.value = rosterData.trim();
                    }
                }
            }

            if (parseRoster(rosterData)) {
                if (!isInitialLoad) {
                    showModal("Roster Loaded", `Successfully loaded ${masterRoster.length} players from ${source}.`);
                }
            } else {
                showModal("Roster Error", `Failed to parse players from ${source}.`);
            }
        };

        const createPlayerCard = (player) => {
            const shotClass = player.shot === 'LH' ? 'is-lh' : 'is-rh';
            const isGoalieClass = player.roleId === 'G' || player.name.toLowerCase().includes('goalie') ? 'is-goalie-type' : '';
            
            return `
                <div id="player-${player.id}"
                    class="player-card ${shotClass} ${isGoalieClass} p-3 rounded-lg border shadow-sm flex items-center justify-between text-sm"
                    draggable="true"
                    data-player-id="${player.id}"
                    data-roster-key="${player.rosterKey}"
                    ondragstart="handleDragStart(event)">
                    <span class="font-bold">${player.name}</span>
                    <span class="text-xs font-mono ml-2 p-1 rounded bg-white/50 border border-current">${player.number} / ${player.shot}</span>
                </div>
            `;
        };

        const createLineupSlot = (slotId, slot) => {
            const playerCard = slot.player ? createPlayerCard(slot.player) : 
                `<div class="text-gray-400 text-center text-xs p-3">Drag player here</div>`;

            return `
                <div id="${slotId}"
                    class="lineup-slot p-2 rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 hover:bg-gray-100 transition duration-150"
                    ondragover="handleDragOver(event)"
                    ondragleave="handleDragLeave(event)"
                    ondrop="handleDrop(event)">
                    <p class="text-xs font-semibold text-gray-600 mb-1">${slot.role}</p>
                    ${playerCard}
                </div>
            `;
        };

        const renderRoster = () => {
            rosterListEl.innerHTML = availableRoster
                .map(player => createPlayerCard(player))
                .join('');
            rosterCountEl.textContent = availableRoster.length;
        };

        // UPDATED renderForwardLines
        const renderForwardLines = () => {
            forwardLinesEl.innerHTML = Object.entries(currentLineup.forwards).map(([lineKey, lineSlots], lineIndex) => {
                const lineNum = lineIndex + 1; // lineKey will be 'Line1', 'Line2', etc.
                const slotHTML = Object.values(lineSlots).map(slot => 
                    createLineupSlot(`F${lineNum}-${slot.roleId}`, slot) // Still use old ID format for DOM manipulation
                ).join('');

                return `
                    <div class="p-4 border border-gray-200 rounded-lg bg-blue-50/50">
                        <h4 class="font-bold text-blue-700 mb-2">Line ${lineNum}</h4>
                        <div class="grid grid-cols-3 gap-3">
                            ${slotHTML}
                        </div>
                    </div>
                `;
            }).join('');
        };

        // UPDATED renderDefenseLines
        const renderDefenseLines = () => {
            defenseLinesEl.innerHTML = Object.entries(currentLineup.defense).map(([pairKey, pairSlots], pairIndex) => {
                const pairNum = pairIndex + 1; // pairKey will be 'Pair1', 'Pair2', etc.
                const slotHTML = Object.values(pairSlots).map(slot => 
                    createLineupSlot(`D${pairNum}-${slot.roleId}`, slot) // Still use old ID format for DOM manipulation
                ).join('');

                return `
                    <div class="p-4 border border-gray-200 rounded-lg bg-green-50/50">
                        <h4 class="font-bold text-green-700 mb-2">Pairing ${pairNum}</h4>
                        <div class="grid grid-cols-2 gap-3">
                            ${slotHTML}
                        </div>
                    </div>
                `;
            }).join('');
        };

        const renderGoalieLine = () => {
            goalieLineEl.innerHTML = createLineupSlot('G1-G', currentLineup.goalie);
        };

        const renderAll = () => {
            renderRoster();
            renderForwardLines();
            renderDefenseLines();
            renderGoalieLine();
        };

        let draggedPlayer = null;
        let originalSourceId = null;

        window.handleDragStart = (event) => {
            const playerId = event.target.dataset.playerId;
            draggedPlayer = masterRoster.find(p => p.id === playerId);
            originalSourceId = event.target.closest('.lineup-slot') ? event.target.closest('.lineup-slot').id : 'roster';
            
            event.dataTransfer.setData('text/plain', playerId);
            event.dataTransfer.effectAllowed = 'move';
            event.target.classList.add('opacity-50');
        };

        window.handleDragOver = (event) => {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
        };

        window.handleDragLeave = (event) => {
            event.currentTarget.classList.remove('drag-over');
        };

        window.handleDrop = (event) => {
            event.preventDefault();
            const dropTarget = event.currentTarget;
            dropTarget.classList.remove('drag-over');

            if (!draggedPlayer) return;

            removePlayer(draggedPlayer.id, originalSourceId);

            if (dropTarget.id === 'roster-list') {
                placePlayerInRoster(draggedPlayer);
                showModal("Player Removed", `${draggedPlayer.name} is back in the available roster.`);
            } else {
                const targetSlotId = dropTarget.id;
                const existingPlayer = getPlayerInLineupSlot(targetSlotId);

                if (existingPlayer) {
                    removePlayer(existingPlayer.id, targetSlotId);
                    placePlayerInRoster(existingPlayer);
                }

                placePlayerInLineupSlot(targetSlotId, draggedPlayer);
                showModal("Line Change", `${draggedPlayer.name} placed at ${getRoleName(targetSlotId)}.`);
            }

            draggedPlayer = null;
            originalSourceId = null;
            renderAll();
        };

        window.handleDragEnd = (event) => {
            event.target.classList.remove('opacity-50');
            draggedPlayer = null; 
            originalSourceId = null;
        };
        document.addEventListener('dragend', window.handleDragEnd);

        // NEW HELPER FUNCTION TO GET THE OBJECT KEY
        const getLineKey = (type, lineNum) => {
            if (type === 'F') return `Line${lineNum}`;
            if (type === 'D') return `Pair${lineNum}`;
            return null;
        };

        // UPDATED getRoleName
        const getRoleName = (slotId) => {
            const match = slotId.match(/([A-Z])(\d+)-([A-Z]+)/);
            if (!match) return "Unknown Slot";
            const [fullMatch, type, lineNumStr, roleId] = match;
            const lineNum = parseInt(lineNumStr);

            if (type === 'F') {
                const lineKey = getLineKey(type, lineNum);
                return currentLineup.forwards[lineKey]?.[roleId]?.role || `${roleId} (Forward Line ${lineNum})`;
            } else if (type === 'D') {
                const lineKey = getLineKey(type, lineNum);
                return currentLineup.defense[lineKey]?.[roleId]?.role || `${roleId} (Defense Pair ${lineNum})`;
            } else if (type === 'G') {
                return currentLineup.goalie.role;
            }
            return "Unknown Slot";
        };

        // UPDATED getPlayerInLineupSlot
        const getPlayerInLineupSlot = (slotId) => {
            const match = slotId.match(/([A-Z])(\d+)-([A-Z]+)/);
            if (!match) return null;
            const [fullMatch, type, lineNumStr, roleId] = match;
            const lineNum = parseInt(lineNumStr);

            if (type === 'F') {
                const lineKey = getLineKey(type, lineNum);
                return currentLineup.forwards[lineKey]?.[roleId]?.player || null;
            } else if (type === 'D') {
                const lineKey = getLineKey(type, lineNum);
                return currentLineup.defense[lineKey]?.[roleId]?.player || null;
            } else if (type === 'G') {
                return currentLineup.goalie.player;
            }
            return null;
        };

        // UPDATED removePlayer
        const removePlayer = (playerId, sourceId) => {
            if (sourceId === 'roster') {
                availableRoster = availableRoster.filter(p => p.id !== playerId);
            } else {
                const match = sourceId.match(/([A-Z])(\d+)-([A-Z]+)/);
                if (!match) return;
                const [fullMatch, type, lineNumStr, roleId] = match;
                const lineNum = parseInt(lineNumStr);

                if (type === 'F') {
                    const lineKey = getLineKey(type, lineNum);
                    if (currentLineup.forwards[lineKey] && currentLineup.forwards[lineKey][roleId]) {
                        currentLineup.forwards[lineKey][roleId].player = null;
                    }
                } else if (type === 'D') {
                    const lineKey = getLineKey(type, lineNum);
                    if (currentLineup.defense[lineKey] && currentLineup.defense[lineKey][roleId]) {
                        currentLineup.defense[lineKey][roleId].player = null;
                    }
                } else if (type === 'G') {
                    currentLineup.goalie.player = null;
                }
            }
        };

        const placePlayerInRoster = (player) => {
            if (!availableRoster.some(p => p.id === player.id)) {
                availableRoster.push(player);
                availableRoster.sort((a, b) => a.name.localeCompare(b.name));
            }
        };

        // UPDATED placePlayerInLineupSlot
        const placePlayerInLineupSlot = (slotId, player) => {
            const match = slotId.match(/([A-Z])(\d+)-([A-Z]+)/);
            if (!match) return;
            const [fullMatch, type, lineNumStr, roleId] = match;
            const lineNum = parseInt(lineNumStr);

            if (type === 'F') {
                const lineKey = getLineKey(type, lineNum);
                if (currentLineup.forwards[lineKey] && currentLineup.forwards[lineKey][roleId]) {
                    currentLineup.forwards[lineKey][roleId].player = player;
                }
            } else if (type === 'D') {
                const lineKey = getLineKey(type, lineNum);
                if (currentLineup.defense[lineKey] && currentLineup.defense[lineKey][roleId]) {
                    currentLineup.defense[lineKey][roleId].player = player;
                }
            } else if (type === 'G') {
                currentLineup.goalie.player = player;
            }
        };

        csvInputEl.value = DEFAULT_ROSTER_CSV.trim();
        initializeFirebase();
        
    </script>
</body>
</html>
